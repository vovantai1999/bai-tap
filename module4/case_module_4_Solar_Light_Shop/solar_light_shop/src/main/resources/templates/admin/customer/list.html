        <!DOCTYPE html>
        <html xmlns:th="http://www.thymeleaf.org" lang="en">

        <head>
            <title>Quản lý khách hàng</title>
            <th:block th:replace="/admin/layout/head :: headCustomer"/>
        </head>


        <body>

        <!-- Begin page -->
        <div id="wrapper">


            <!-- Topbar Start -->
            <th:block th:replace="/admin/layout/top-nav :: top-nav"/>
            <!-- end Topbar --> <!-- ========== Left Sidebar Start ========== -->
            <th:block th:replace="/admin/layout/left-nav :: left-nav"/>
            <!-- Left Sidebar End -->

            <!-- ============================================================== -->
            <!-- Loading -->
            <!--        <div id="loader hide">-->
            <!--            <div class="container mt-4">-->
            <!--                <div class="spinner-grow text-muted"></div>-->
            <!--                <div class="spinner-grow text-primary"></div>-->
            <!--                <div class="spinner-grow text-success"></div>-->
            <!--                <div class="spinner-grow text-info"></div>-->
            <!--                <div class="spinner-grow text-warning"></div>-->
            <!--                <div class="spinner-grow text-danger"></div>-->
            <!--                <div class="spinner-grow text-secondary"></div>-->
            <!--                <div class="spinner-grow text-dark"></div>-->
            <!--                <div class="spinner-grow text-light"></div>-->
            <!--            </div>-->
            <!--        </div>-->
            <!-- ============================================================== -->

            <div class="content-page">
                <div class="content">

                    <!-- Start container-fluid -->
                    <div class="container-fluid">

                        <div class="row">
                            <div class="col-12">
                            </div>
                        </div>
                        <!-- end row -->
                        <div class="row">
                            <div class="col-12">
                                <div>
                                    <div class="row">
                                        <div class="col-md-8"><h3 class="font-24">Danh sách khách hàng </h3></div>
                                        <div class="col-md-4" style="float: right; margin-bottom: 5px">
                                            <button id="btnShowCreateModal" class="btn btn-outline-primary" style="float:right">
                                                <i class="fa-solid fa-square-plus"></i>
                                                Thêm khách hàng mới
                                            </button>
                                        </div>
                                    </div>

                                    <table id="datatable" class="table table-bordered dt-responsive nowrap tbCustomer"
                                           style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                        <thead>
                                        <tr>
                                            <th>Id</th>
                                            <th>Ảnh</th>
                                            <th>Họ và tên</th>
                                            <th>Email</th>
                                            <th>Số ĐT</th>
                                            <th>Tỉnh/TP</th>
                                            <th>Quận/Huyện</th>
                                            <th>Phường/Xã</th>
                                            <th>Địa chỉ</th>
                                            <th colspan="2" class="text-center">Công cụ</th>
                                        </tr>
                                        </thead>

                                        <tbody>

                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>

                        <!--end row -->

                        <!-- end row -->


                        <!-- end row -->

                    </div>
                    <!-- end container-fluid -->


                    <!-- Footer Start -->
                    <th:block th:replace="/admin/layout/footer :: footer"/>

                    <!--  Modal create-->
                    <th:block th:replace="/admin/customer/modalCreateCustomer :: modalCreateCustomer"/>
                    <!--  End modal create-->

                    <!--  Modal Update-->
                    <th:block th:replace="/admin/customer/modalUpdateCustomer :: modalUpdateCustomer"/>
                    <!-- end Footer -->
                </div>
                <!-- end content -->

            </div>
            <!-- END content-page -->

            <!--  End modal Update-->
        </div>
        <!-- END wrapper -->

        <!-- Vendor js -->
        <th:block th:replace="/admin/layout/script-tables :: script-table"/>
        <th:block th:replace="/admin/layout/script :: scriptCustomer"/>
        </body>

        <script>

            let page = {
                urls: {
                    getAllCustomers: App.CUSTOMER_API,
                    getAllDeletedCustomer: App.CUSTOMER_API + "deleted-customer",
                    getCustomerById: App.CUSTOMER_API,
                    createCustomer: App.CUSTOMER_API,
                    updateCustomer: App.CUSTOMER_API,
                    deleteCustomer: App.CUSTOMER_API + "/delete",
                    getAllProvinces: App.PROVINCE_URL,
                    getAllDistrictsByProvinceId: App.PROVINCE_URL + "district/",
                    getAllWardsByDistrictId: App.PROVINCE_URL + "ward/",
                    error_403: App.ERROR_URL + "403",
                    getCustomerAvatarById: App.CUSTOMER_AVATAR_URL,
                    registerCustomer: App.REGISTER_USER
                },
                dialogs: {
                    elements: {},
                    loadData: {},
                    commands: {},
                    alertDanger: {},
                },
                elements: {},
                commands: {},
                alertDanger: {},
                initializeEventControl: {}
            }

            page.elements.loader = $(".modal-content .modal-header #loader");

            page.elements.btnShowCreateModal = $("#btnShowCreateModal");
            page.elements.tbCustomer = $(".tbCustomer");
            page.elements.tbCustomerBody = $(".tbCustomer tbody");

            page.dialogs.elements.modalCreateCustomer = $("#modalCreateCustomer");
            page.dialogs.elements.frmCreateCustomer = $("#frmCreateCustomer");
            page.dialogs.elements.fullNameCre = $("#fullNameCre");
            page.dialogs.elements.emailCre = $("#emailCre");
            page.dialogs.elements.phoneCre = $("#phoneCre");
            page.dialogs.elements.provinceCre = $("#provinceIdCre");
            page.dialogs.elements.districtCre = $("#districtIdCre");
            page.dialogs.elements.wardCre = $("#wardIdCre");
            page.dialogs.elements.addressCre = $("#addressCre");

            page.dialogs.alertDanger.frmCreate = $("#frmUpdateCustomer .frm-alert-danger");


            page.dialogs.elements.btnCreate = $("#btnCreate");

            page.dialogs.elements.modalUpdateCustomer = $("#modalUpdateCustomer");
            page.dialogs.elements.frmUpdateCustomer = $("#frmUpdateCustomer");
            page.dialogs.elements.customerIdUp = $("#customerIdUp");
            page.dialogs.elements.fullNameUp = $("#fullNameUp");
            page.dialogs.elements.emailUp = $("#emailUp");
            page.dialogs.elements.phoneUp = $("#phoneUp");
            page.dialogs.elements.locationRegionIdUp = $("#locationRegionIdUp");
            page.dialogs.elements.provinceUp = $("#provinceIdUp");
            page.dialogs.elements.districtUp = $("#districtIdUp");
            page.dialogs.elements.wardUp = $("#wardIdUp");
            page.dialogs.elements.addressUp = $("#addressUp");
            page.dialogs.elements.btnUpdate = $("#btnUpdate");
            page.dialogs.alertDanger.frmUpdate = $("#frmUpdateCustomer .frm-alert-danger");


            page.dialogs.elements.wrapperCre = $("#frmCreateCustomer section .wrapper1");
            page.dialogs.elements.imageFileCre = $("#imageFileCre");
            page.dialogs.elements.wrapperContentCre = $("#frmCreateCustomer section .wrapper1 .content1");
            page.dialogs.elements.imagePreviewCre = $("#frmCreateCustomer section .image-preview1 canvas");
            page.dialogs.elements.canvasCre = $("#canvasCre");
            page.dialogs.elements.contextCre = page.dialogs.elements.canvasCre[0].getContext('2d');
            page.dialogs.elements.imagePreviewCre.css("display", "none");
            page.dialogs.elements.divImagePreviewCre = $("#frmCreateCustomer div.image-preview1,#frmCreateCustomer div.file-name");

            page.dialogs.elements.wrapperUp = $("#frmUpdateCustomer section .wrapper1");
            page.dialogs.elements.imageFileUp = $("#imageFileUp");
            page.dialogs.elements.wrapperContentUp = $("#frmUpdateCustomer section .wrapper1 .content1");
            page.dialogs.elements.imagePreviewUp = $("#frmUpdateCustomer section .image-preview1 canvas");
            page.dialogs.elements.canvasUp = $("#canvasUp");
            page.dialogs.elements.contextUp = page.dialogs.elements.canvasUp[0].getContext('2d');
            page.dialogs.elements.imagePreviewUp.css("display", "none");
            page.dialogs.elements.divImagePreviewUp = $("#frmUpdateCustomer div.image-preview1, #frmUpdateCustomer div.file-name");


            let customer = new Customer();
            let locationRegion = new LocationRegion();
            let customerAvatar = new CustomerAvatar();
            // let user = new User();

            page.commands.enableTooltip = () => {
                let icons = document.querySelectorAll('[data-toggle="tooltip"]');
                icons.forEach((icon) => {
                    new bootstrap.Tooltip(icon);
                })
            }

            page.commands.getAllCustomers = () => {
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "GET",
                    url: page.urls.getAllCustomers,
                })
                    .done((data) => {
                        $.each(data, (i, item) => {
                            customerAvatar = item;
                            customer = customerAvatar.customer;
                            locationRegion = customer.locationRegion;
                            page.elements.tbCustomerBody.prepend(page.commands.renderCustomer(customerAvatar, customer, locationRegion));
                        });

                        page.commands.enableTooltip();

                        page.commands.removeHandleShowModal();

                        page.commands.handleShowGroupModal();
                    })
                    .fail((error) => {
                        console.log(error);
                    })
            }

            page.commands.renderCustomer = (obj, customer, locationRegion) => {
                let image_thumbnail = App.BASE_URL_CLOUD_IMAGE + "/" + App.SCALE_IMAGE_W100_H80_Q100 + "/" + obj.fileFolder + "/" + obj.fileName;
                return `
                        <tr id="tr_${customer.id}">
                            <td>${customer.id}</td>
                            <td>
                                <img src=${image_thumbnail} alt="${obj.id}">
                            </td>
                            <td>${customer.fullName}</td>
                            <td>${customer.email}</td>
                            <td>${customer.phone}</td>
                            <td>${locationRegion.provinceName}</td>
                            <td>${locationRegion.districtName}</td>
                            <td>${locationRegion.wardName}</td>
                            <td>${locationRegion.address}</td>
                            <td class="text-center">
                                <button data-id="${customer.id}"
                                        data-avatar-id = "${obj.id}"
                                        data-avatar-file-folder = "${obj.fileFolder}"
                                        data-avatar-file-name = "${obj.fileName}"
                                        class="btn btn btn-outline-dark update"
                                        title="Sửa"
                                        data-toggle="tooltip"
                                        data-bs-original-title="Edit"
                                        data-bs-placement="top"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalUpdateCustomer">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                            </td>
                            <td>
                                  <button data-id="${customer.id}"
                                        class="btn btn-outline-danger delete"
                                        title="Xóa"
                                        data-toggle="tooltip"
                                        data-bs-original-title="Edit"
                                        data-bs-placement="top">
                                        <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            }

            //-Load image Update-//
            page.dialogs.commands.loadImageToCanvasUp = (imageFile, fileType, imageUrl) => {
                page.dialogs.elements.imagePreviewUp.css("display", "");
                page.dialogs.elements.wrapperUp.addClass("active");
                page.dialogs.elements.wrapperContentUp.css("opacity", 0);

                let imageObj = new Image();

                imageObj.onload = function () {
                    page.dialogs.elements.contextUp.canvas.width = imageObj.width;
                    page.dialogs.elements.contextUp.canvas.height = imageObj.height;
                    page.dialogs.elements.contextUp.drawImage(imageObj, 0, 0, imageObj.width, imageObj.height);
                };
                if (fileType === "BINARY") {
                    imageObj.src = URL.createObjectURL(imageFile);
                } else {
                    imageObj.src = imageUrl;
                }
            }

            page.dialogs.commands.changeImagePreviewUp = () => {
                let imageFile = page.dialogs.elements.imageFileUp[0].files[0];

                if (imageFile) {
                    let reader = new FileReader();

                    reader.readAsDataURL(imageFile);

                    reader.onload = function (e) {
                        if (e.target.readyState === FileReader.DONE) {
                            page.dialogs.commands.loadImageToCanvasUp(imageFile, "BINARY", null);
                        }
                    }
                } else {
                    page.dialogs.elements.clearImagePreviewUp();
                }
            }

            page.dialogs.elements.clearImagePreviewUp = () => {
                page.dialogs.elements.imageFileUp.val("");
                page.dialogs.elements.imagePreviewUp.css("display", "none");
                page.dialogs.elements.wrapperUp.removeClass("active");
                page.dialogs.elements.wrapperContentUp.css("opacity", 1);
            }
            //--//

            //-Load image Create-//
            page.dialogs.commands.loadImageToCanvasCre = (imageFile) => {
                page.dialogs.elements.imagePreviewCre.css("display", "");
                page.dialogs.elements.wrapperCre.addClass("active");
                page.dialogs.elements.wrapperContentCre.css("opacity", 0);

                let imageObj = new Image();

                imageObj.onload = function () {
                    page.dialogs.elements.contextCre.canvas.width = imageObj.width;
                    page.dialogs.elements.contextCre.canvas.height = imageObj.height;
                    page.dialogs.elements.contextCre.drawImage(imageObj, 0, 0, imageObj.width, imageObj.height);
                };

                imageObj.src = URL.createObjectURL(imageFile)
            }

            page.dialogs.commands.changeImagePreviewCre = () => {
                let imageFile = page.dialogs.elements.imageFileCre[0].files[0];

                if (imageFile) {
                    let reader = new FileReader();

                    reader.readAsDataURL(imageFile);

                    reader.onload = function (e) {
                        if (e.target.readyState === FileReader.DONE) {
                            page.dialogs.commands.loadImageToCanvasCre(imageFile);
                        }
                    }
                } else {
                    page.dialogs.elements.clearImagePreviewCre();
                }
            }

            page.dialogs.elements.clearImagePreviewCre = () => {
                page.dialogs.elements.imageFileCre.val("");
                page.dialogs.elements.imagePreviewCre.css("display", "none");
                page.dialogs.elements.wrapperCre.removeClass("active");
                page.dialogs.elements.wrapperContentCre.css("opacity", 1);
            }

            page.dialogs.elements.clearImagePreviewUp = () => {
                page.dialogs.elements.imageFileUp.val("");
                page.dialogs.elements.imagePreviewUp.css("display", "none");
                page.dialogs.elements.wrapperUp.removeClass("active");
                page.dialogs.elements.wrapperContentUp.css("opacity", 1);
            }
            //--//

            page.commands.getAllProvinces = () => {
                return $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "GET",
                    url: page.urls.getAllProvinces
                })
                    .done((data) => {
                        let results = data.results;

                        results.map(item => {
                            let str = `<option value="${item.province_id}">${item.province_name}</option>`;
                            page.dialogs.elements.provinceCre.append(str);
                            page.dialogs.elements.provinceUp.append(str);
                        })

                    })
                    .fail((error) => {
                        console.log(error);
                        console.log("Không thể tải dữ liệu Tỉnh/Thành phố");
                    })
            }

            page.commands.getAllDistrictsByProvinceId = (provinceId) => {
                return $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "GET",
                    url: page.urls.getAllDistrictsByProvinceId + provinceId
                })
                    .done((data) => {

                        page.dialogs.elements.districtCre.empty();
                        page.dialogs.elements.districtUp.empty();

                        let results = data.results;

                        results.map(item => {
                            let str = `<option value="${item.district_id}">${item.district_name}</option>`;
                            page.dialogs.elements.districtCre.append(str);
                            page.dialogs.elements.districtUp.append(str);
                        })
                    })
                    .fail((error) => {
                        console.log(error);
                        console.log("Không thể tải dữ liệu Thành phố/Quận/Huyện");
                    })
            }

            page.commands.getAllWardsByDistrictId = (districtId) => {
                return $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "GET",
                    url: page.urls.getAllWardsByDistrictId + districtId
                })
                    .done((data) => {
                        page.dialogs.elements.wardCre.empty();
                        page.dialogs.elements.wardUp.empty();

                        let results = data.results;

                        results.map(item => {
                            let str = `<option value="${item.ward_id}">${item.ward_name}</option>`;
                            page.dialogs.elements.wardCre.append(str);
                            page.dialogs.elements.wardUp.append(str);
                        })
                    })
                    .fail((error) => {
                        console.log(error);
                        console.log("Không thể tải dữ liệu Phường/Xã/Thị trấn");
                    })
            }

            page.dialogs.elements.provinceCre.on("change", function () {
                let provinceId = $(this).val();

                page.commands.getAllDistrictsByProvinceId(provinceId).then(() => {
                    let districtId = page.dialogs.elements.districtCre.val();

                    page.commands.getAllWardsByDistrictId(districtId);
                });

            });

            page.dialogs.elements.districtCre.on("change", function () {
                let districtId = $(this).val();

                page.commands.getAllWardsByDistrictId(districtId);
            });

            page.dialogs.elements.provinceUp.on("change", function () {
                let provinceId = $(this).val();

                page.commands.getAllDistrictsByProvinceId(provinceId).then(() => {
                    let districtId = page.dialogs.elements.districtUp.val();
                    page.commands.getAllWardsByDistrictId(districtId);
                });
            });

            page.dialogs.elements.districtUp.on("change", function () {
                let districtId = $(this).val();
                page.commands.getAllWardsByDistrictId(districtId);
            })
            //  End Province //


            page.dialogs.commands.handleCloseCreateModal = () => {
                page.dialogs.alertDanger.modalCreateCustomer = $("#modalCreateCustomer .modal-body .modal-alert-danger");
                page.dialogs.elements.frmCreateCustomer.find("input.error").removeClass("error");
                page.dialogs.elements.frmCreateCustomer[0].reset();
                page.dialogs.elements.frmCreateCustomer.validate().resetForm();
                page.dialogs.elements.clearImagePreviewCre();
            }

            page.dialogs.commands.handleCloseUpdateModal = () => {
                page.dialogs.alertDanger.modalUpdateCustomer = $("#modalUpdateCustomer .modal-body .modal-alert-danger");
                page.dialogs.elements.frmUpdateCustomer.find("input.error").removeClass("error");
                page.dialogs.elements.frmUpdateCustomer[0].reset();
                page.dialogs.elements.frmUpdateCustomer.validate().resetForm();
                page.dialogs.elements.clearImagePreviewUp();
            }

            //  Create //
            page.commands.handleShowCreateModal = () => {
                page.elements.btnShowCreateModal.on("click", () => {
                    page.dialogs.elements.modalCreateCustomer.modal("show");
                })
            }

            page.dialogs.elements.btnCreate.on("click", () => {
                page.dialogs.elements.frmCreateCustomer.trigger("submit");
            })

            page.dialogs.elements.frmCreateCustomer.validate({
                rules: {
                    fullNameCre: {
                        required: true,
                        minlength: 5,
                        maxlength: 50
                    },
                    emailCre: {
                        required: true,
                        minlength: 5,
                        maxlength: 50,
                        email: true
                    },
                    phoneCre: {
                        phone_valid: true,
                        required: true,
                    }
                },
                messages: {
                    fullNameCre: {
                        required: " Vui lòng nhập tên đầy đủ, ",
                        minlength: " Độ dài tối thiểu là 5 ký tự, ",
                        maxlength: " Độ dài tối đa là 100 ký tự, "
                    },
                    emailCre: {
                        required: " Vui lòng nhập email đầy đủ, ",
                        minlength: " Độ dài tối thiểu là 5 ký tự, ",
                        maxlength: " Độ dài tối đa là 100 ký tự, ",
                        email: " Định dạng email không đúng, "
                    },
                    phoneCre: {
                        phone_valid: " Định dạng số điện thoại không đúng, số điện thoại có 10 số bắt đầu bằng 0, vd: 0345678999,   ",
                        required: " Vui lòng nhập số điện thoại đầy đủ, "
                    }
                },
                errorLabelContainer: "#frmCreateCustomer .frm-alert-danger",
                errorPlacement: function (error) {
                    error.appendTo("#frmCreateCustomer .frm-alert-danger");
                },
                showErrors: function () {
                    if (this.numberOfInvalids() > 0) {
                        page.dialogs.alertDanger.frmCreate.removeClass("hide").addClass("show");
                    } else {
                        page.dialogs.alertDanger.frmCreate.removeClass("show").addClass("hide").empty();
                        $("#frmCreateStaff input.error").removeClass("error");
                    }
                    this.defaultShowErrors();
                },
                submitHandler: function () {
                    locationRegion.provinceId = page.dialogs.elements.provinceCre.val();
                    locationRegion.provinceName = page.dialogs.elements.provinceCre.find("option:selected").text();
                    locationRegion.districtId = page.dialogs.elements.districtCre.val();
                    locationRegion.districtName = page.dialogs.elements.districtCre.find("option:selected").text();
                    locationRegion.wardId = page.dialogs.elements.wardCre.val();
                    locationRegion.wardName = page.dialogs.elements.wardCre.find("option:selected").text();
                    locationRegion.address = page.dialogs.elements.addressCre.val();

                    customer.fullName = page.dialogs.elements.fullNameCre.val();
                    customer.email = page.dialogs.elements.emailCre.val();
                    customer.phone = page.dialogs.elements.phoneCre.val();
                    customer.locationRegion = locationRegion;

                    let formData = new FormData();
                    formData.append("fullName", customer.fullName);
                    formData.append("email", customer.email);
                    formData.append("phone", customer.phone);
                    formData.append("provinceId", locationRegion.provinceId);
                    formData.append("provinceName", locationRegion.provinceName);
                    formData.append("districtId", locationRegion.districtId);
                    formData.append("districtName", locationRegion.districtName);
                    formData.append("wardId", locationRegion.wardId);
                    formData.append("wardName", locationRegion.wardName);
                    formData.append("address", locationRegion.address);
                    formData.append("file", page.dialogs.elements.imageFileCre[0].files[0]);

                    page.commands.createCustomer(formData);
                }
            })

            page.commands.createCustomer = (formData) => {
                page.commands.showLoading();
            $.ajax({
                type: "POST",
                contentType: false,
                cache: false,
                processData: false,
                url: page.urls.createCustomer,
                data: formData
            })
                .done((data) => {
                    customerAvatar = data;
                    customer = customerAvatar.customer;
                    locationRegion = customer.locationRegion;
                    let str = page.commands.renderCustomer(customerAvatar, customer, locationRegion);
                    page.elements.tbCustomerBody.prepend(str);
                    page.commands.removeHandleShowModal();
                    page.commands.handleShowGroupModal();
                    page.dialogs.elements.modalCreateCustomer.modal("hide");
                    App.IziToast.showSuccessAlertLeft("Thêm mới khách hàng <b>'" + customer.fullName + "'</b> thành công.");
                })
                .fail((jqXHR) => {
                    let str = ``;
                    console.log(jqXHR.status);
                    if (jqXHR.status === 401) {
                        App.SweetAlert.showError401();
                    } else {
                        if (jqXHR.status === 403) {

                            App.SweetAlert.showError403();
                        } else {
                            if (jqXHR.responseJSON) {
                                if (jqXHR.responseJSON.message) {
                                    str += `<label id="message-error" class="error" for="message">${jqXHR.responseJSON.message}</label>`;
                                } else {
                                    $.each(jqXHR.responseJSON, function (key, value) {
                                        str += `<label id="${key}Up-error" class="error" for="${key}Up">${value}</label>`;
                                        $("#" + key + "Up").addClass("error");
                                    });
                                    page.dialogs.alertDanger.frmCreate.removeClass("hide").addClass("show");
                                    page.dialogs.alertDanger.frmCreate.css("display", "block")
                                    page.dialogs.alertDanger.frmCreate.append(str);
                                }
                            } else {
                                App.SweetAlert.showError500();
                            }
                        }
                    }
                }).always(function () {
                page.commands.closeLoading();
            });
            }
            //END CREATE//

            page.commands.showLoading = () => {
                page.elements.loader.css('z-index', 1);
                page.dialogs.elements.btnCreate.prop('disabled', true);
                page.dialogs.elements.btnUpdate.prop('disabled', true);

            }

            page.commands.closeLoading = () => {
                page.elements.loader.css('z-index', -1);
                page.dialogs.elements.btnCreate.prop('disabled', false);
                page.dialogs.elements.btnUpdate.prop('disabled', false);
            }


            // UPDATE CUSTOMER //
            page.commands.handleShowUpdateModal = () => {
                $(".update").on("click", function () {
                    let id = $(this).data("id");
                    let avatarFileFolder = $(this).data("avatar-file-folder");
                    let avatarFileName = $(this).data("avatar-file-name");
                    page.commands.getCustomerById(id).done((data) => {

                        let avatarUrl = App.BASE_URL_CLOUD_IMAGE + "/" + App.SCALE_IMAGE_W600_H650_Q100 + "/" + avatarFileFolder + "/" + avatarFileName;
                        page.dialogs.commands.loadImageToCanvasUp(null, "", avatarUrl);

                        customer = data;
                        locationRegion = customer.locationRegion;
                        page.dialogs.elements.customerIdUp.val(id);
                        page.dialogs.elements.fullNameUp.val(customer.fullName);
                        page.dialogs.elements.emailUp.val(customer.email);
                        page.dialogs.elements.phoneUp.val(customer.phone);

                        page.dialogs.elements.locationRegionIdUp.val(locationRegion.id);
                        page.dialogs.elements.provinceUp.val(customer.locationRegion.provinceId);
                        page.commands.getAllDistrictsByProvinceId(customer.locationRegion.provinceId).then(() => {
                            page.dialogs.elements.districtUp.val(customer.locationRegion.districtId)
                            page.commands.getAllWardsByDistrictId(customer.locationRegion.districtId).then(() => {
                                page.dialogs.elements.wardUp.val(customer.locationRegion.wardId);
                                page.dialogs.elements.addressUp.val(customer.locationRegion.address);
                                page.dialogs.elements.modalUpdateCustomer.modal('show');
                            })
                        })
                    })
                })
            }

            page.dialogs.elements.btnUpdate.on("click", () => {
                page.dialogs.elements.frmUpdateCustomer.submit();
            })

            page.dialogs.elements.frmUpdateCustomer.validate({
                rules: {
                    fullNameUp: {
                        required: true,
                        minlength: 5,
                        maxlength: 50
                    },
                    emailUp: {
                        required: true,
                        minlength: 5,
                        maxlength: 50,
                        email: true
                    },
                    phoneUp: {
                        phone_valid: true,
                        required: true,
                    }
                },
                messages: {
                    fullNameUp: {
                        required: " Vui lòng nhập tên đầy đủ, ",
                        minlength: " Độ dài tối thiểu là 5 ký tự, ",
                        maxlength: " Độ dài tối đa là 100 ký tự, "
                    },
                    emailUp: {
                        required: " Vui lòng nhập email đầy đủ, ",
                        minlength: " Độ dài tối thiểu là 5 ký tự, ",
                        maxlength: " Độ dài tối đa là 100 ký tự, ",
                        email: "  Định dạng email không đúng, "
                    },
                    phoneUp: {
                        phone_valid: " Định dạng số điện thoại không đúng, số điện thoại có 10 số bắt đầu bằng 0, : 0345678999,  ",
                        required: " Vui lòng nhập số điện thoại đầy đủ, "
                    }
                },
                    errorLabelContainer: "#frmUpdateCustomer .frm-alert-danger",
                    errorPlacement: function (error) {
                        error.appendTo("#frmUpdateCustomer .frm-alert-danger");
                    },
                    showErrors: function () {
                        if (this.numberOfInvalids() > 0) {
                            page.dialogs.alertDanger.frmUpdate.removeClass("hide").addClass("show");
                        } else {
                            page.dialogs.alertDanger.frmUpdate.removeClass("show").addClass("hide").empty();
                            $("#frmCreateStaff input.error").removeClass("error");
                        }
                        this.defaultShowErrors();
                    },
                submitHandler: function () {
                    customer.id = page.dialogs.elements.customerIdUp.val();
                    customer.fullName = page.dialogs.elements.fullNameUp.val();
                    customer.email = page.dialogs.elements.emailUp.val();
                    customer.phone = page.dialogs.elements.phoneUp.val();


                    locationRegion.id = page.dialogs.elements.locationRegionIdUp.val();
                    locationRegion.provinceId = page.dialogs.elements.provinceUp.val();
                    locationRegion.provinceName = page.dialogs.elements.provinceUp.find("option:selected").text();
                    locationRegion.districtId = page.dialogs.elements.districtUp.val();
                    locationRegion.districtName = page.dialogs.elements.districtUp.find("option:selected").text();
                    locationRegion.wardId = page.dialogs.elements.wardUp.val();
                    locationRegion.wardName = page.dialogs.elements.wardUp.find("option:selected").text();
                    locationRegion.address = page.dialogs.elements.addressUp.val();

                    let formData = new FormData();
                    formData.append("id", customer.id);
                    formData.append("fullName", customer.fullName);
                    formData.append("email", customer.email);
                    formData.append("phone", customer.phone);

                    formData.append("locationId", locationRegion.id);
                    formData.append("provinceId", locationRegion.provinceId);
                    formData.append("provinceName", locationRegion.provinceName);
                    formData.append("districtId", locationRegion.districtId);
                    formData.append("districtName", locationRegion.districtName);
                    formData.append("wardId", locationRegion.wardId);
                    formData.append("wardName", locationRegion.wardName);
                    formData.append("address", locationRegion.address);

                    formData.append("file", page.dialogs.elements.imageFileUp[0].files[0]);
                    console.log("formData:", 1)
                    page.commands.doUpdateCustomer(formData);
                }
            })

            page.commands.doUpdateCustomer = (formData) => {
                page.commands.showLoading();
                $.ajax({
                    type: "PATCH",
                    contentType: false,
                    cache: false,
                    processData: false,
                    url: page.urls.updateCustomer + "/" + customer.id,
                    data: formData
                })
                    .done((data) => {
                        customerAvatar = data;
                        customer = customerAvatar.customer;
                        locationRegion = customer.locationRegion;
                        let str = page.commands.renderCustomer(customerAvatar, customer, locationRegion);
                        let updateRow = $("#tr_" + customer.id);
                        updateRow.replaceWith(str);

                        page.commands.enableTooltip();
                        page.commands.removeHandleShowModal();
                        page.commands.handleShowGroupModal();
                        page.dialogs.elements.modalUpdateCustomer.modal("hide");

                        App.IziToast.showSuccessAlertLeft("Chỉnh sửa khách hàng <b>'" + customer.fullName + "'</b> thành công.")
                    })
                    .fail((jqXHR) => {
                        let str = ``;
                        console.log(jqXHR.status);
                        if (jqXHR.status === 401) {
                            App.SweetAlert.showError401();
                        } else {
                            if (jqXHR.status === 403) {

                                App.SweetAlert.showError403();
                            } else {
                                if (jqXHR.responseJSON) {
                                    if (jqXHR.responseJSON.message) {
                                        str += `<label id="message-error" class="error" for="message">${jqXHR.responseJSON.message}</label>`;
                                    } else {
                                        $.each(jqXHR.responseJSON, function (key, value) {
                                            str += `<label id="${key}Up-error" class="error" for="${key}Up">${value}</label>`;
                                            $("#" + key + "Up").addClass("error");
                                        });
                                        page.dialogs.alertDanger.frmUpdate.removeClass("hide").addClass("show");
                                        page.dialogs.alertDanger.frmUpdate.css("display", "block")
                                        page.dialogs.alertDanger.frmUpdate.append(str);
                                    }
                                } else {
                                    App.SweetAlert.showError500();
                                }
                            }
                        }
                    }).always(function () {
                    page.commands.closeLoading();
                })
            }
            //END UPDATE//

            //--- DELETE CUSTOMER ---//
            page.commands.handleShowConfirmDelete = () => {
                $(".delete").on("click", function () {
                    let id = $(this).data("id");
                    page.commands.getCustomerById(id).then(() => {
                        Swal.fire({
                            title: 'Xóa',
                            text: "Bạn có chắc chắn muốn xóa?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Xóa'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                page.commands.doDeleteCustomer(id)
                            }
                        })
                    })
                });
            }

            page.commands.doDeleteCustomer = (customerId) => {
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "DELETE",
                    url: page.urls.deleteCustomer + "/" + customerId,
                    data: JSON.stringify(customer)
                })
                    .done(() => {
                        $("#tr_" + customerId).remove();
                        App.IziToast.showSuccessAlertLeft("Xóa khách hàng <b>'" + customer.fullName + "'</b> thành công");
                    })
                    .fail((jqXHR) => {
                        console.log("jq: ", jqXHR)
                        if (jqXHR.status === 401) {
                            App.SweetAlert.showError401();
                        } else {
                            if (jqXHR.status === 403) {
                                App.SweetAlert.showError403();
                            } else {
                                App.SweetAlert.showErrorAlert(jqXHR.responseJSON.message);
                                // App.SweetAlert.showErrorAlert(jqXHR.responseJSON);
                            }
                        }
                    })
            }
            //--- END DELETE ---//

            page.commands.getCustomerAvatarByCustomerId = (customerId) => {
                return $.ajax({
                    type: "GET",
                    url: page.urls.getCustomerAvatarById + "/" + customerId
                }).done((data) => {
                    customerAvatar = data;
                    console.log(customerAvatar);
                })
                    .fail((jqXHR) => {
                        let errors = jqXHR.responseJSON;
                        let strError = "";
                        if (errors) {
                            $.each(errors, (k, v) => {
                                strError += `${v}`;
                            })
                        }
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: strError,
                        })
                    })
            }
            //--END--//

            //--- FIND BY ID ---//
            page.commands.getCustomerById = (customerId) => {
                return $.ajax({
                    type: "GET",
                    url: page.urls.getCustomerById + "/" + customerId
                }).done((data) => {
                    customer = data;
                })
                    .fail((jqXHR) => {
                        let errors = jqXHR.responseJSON;
                        let strError = "";
                        if (errors) {
                            $.each(errors, (k, v) => {
                                strError += `${v}`;
                            })
                        }
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: strError,
                        })
                    })
            }
            //--- END FIND BY ID ---//

            //--- SHOW GROUP MODAL ---//
            page.commands.handleShowGroupModal = () => {
                page.commands.handleShowCreateModal();

                page.commands.handleShowUpdateModal();

                page.commands.handleShowConfirmDelete();

            }
            //--- END SHOW GROUP MODAL ---//

            //--- REMOVE SHOW MODAL ---//
            page.commands.removeHandleShowModal = () => {
                page.elements.btnShowCreateModal.off("click");
                $(".edit").off("click");
                $(".delete").off("click");
            }
            //--- END REMOVE SHOW MODAL ---//


            page.commands.loadData = () => {

                page.commands.getAllCustomers();

                page.commands.getAllProvinces().then(() => {
                    let provinceId = page.dialogs.elements.provinceCre.val();

                    page.commands.getAllDistrictsByProvinceId(provinceId).then(() => {
                        let districtId = page.dialogs.elements.districtCre.val();

                        page.commands.getAllWardsByDistrictId(districtId);
                    });
                })

            }

            page.initializeEventControl = () => {
                page.commands.handleShowGroupModal();

                page.dialogs.elements.modalCreateCustomer.on("hidden.bs.modal", function () {
                    page.dialogs.commands.handleCloseCreateModal();
                });

                page.dialogs.elements.modalUpdateCustomer.on("hidden.bs.modal", function () {
                    page.dialogs.commands.handleCloseUpdateModal();
                });

                page.dialogs.elements.divImagePreviewCre.on("click", function () {
                    page.dialogs.elements.imageFileCre.trigger("click");
                });

                page.dialogs.elements.imageFileCre.on("change", function () {
                    page.dialogs.commands.changeImagePreviewCre();
                });

                page.dialogs.elements.divImagePreviewUp.on("click", function () {
                    page.dialogs.elements.imageFileUp.trigger("click");
                });

                page.dialogs.elements.imageFileUp.on("change", function () {
                    page.dialogs.commands.changeImagePreviewUp();
                });

            }

            $(() => {
                page.commands.loadData();
                page.initializeEventControl();
            });
        </script>
        </html>